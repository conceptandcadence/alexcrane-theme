{% comment %}
  Renders a product media gallery using Swiper with left-side thumbnails
  Based on the card-product carousel but adapted for main product page

  Accepts:
  - product: {Object} Product liquid object
  - variant_images: {Array} Product images associated with a variant

  Usage:
  {% render 'product-swiper-gallery' %}
{% endcomment %}

{%- liquid
  if section.settings.hide_variants and variant_images.size == product.media.size
    assign single_media_visible = true
  endif

  assign media_count = product.media.size
  if section.settings.hide_variants and media_count > 1 and variant_images.size > 0
    assign media_count = media_count | minus: variant_images.size | plus: 1
  endif

  if media_count == 1 or single_media_visible
    assign single_media_visible_mobile = true
  endif

  if section.settings.media_size == 'large'
    assign media_width = 0.65
  elsif section.settings.media_size == 'medium'
    assign media_width = 0.55
  elsif section.settings.media_size == 'small'
    assign media_width = 0.45
  endif

  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
-%}

<div
  class='product-swiper-gallery'
  id='ProductSwiperGallery-{{ section.id }}'
  data-product-id='{{ product.id }}'
  data-section-id='{{ section.id }}'
>
  <div class='product-swiper-gallery__container'>
    {%- comment -%} Left Thumbnails {%- endcomment -%}
    {%- if media_count > 1 -%}
      <div class='product-swiper-gallery__thumbnails'>
        <div class='swiper product-thumbnails-swiper' id='ProductThumbnails-{{ section.id }}'>
          <div class='swiper-wrapper'>
            {%- for media in product.media -%}
              {%- unless section.settings.hide_variants
                and variant_images contains media
                and media.id != featured_media.id
              -%}
                <div class='swiper-slide product-thumbnail' data-media-id='{{ media.id }}'>
                  <button
                    type='button'
                    class='product-thumbnail__button'
                    aria-label='Load image {{ forloop.index }} in gallery view'
                  >
                    {%- if media.media_type == 'video' or media.media_type == 'external_video' -%}
                      <span class='product-thumbnail__badge'>
                        <svg class='icon icon-play' viewBox='0 0 18 18' role='img' aria-hidden='true' focusable='false'>
                          <path d="M8.1 7.5 4.5 5.4v4.2l3.6-2.1Z"/>
                        </svg>
                      </span>
                    {%- elsif media.media_type == 'model' -%}
                      <span class='product-thumbnail__badge'>
                        <svg
                          class='icon icon-3d-model'
                          viewBox='0 0 18 18'
                          role='img'
                          aria-hidden='true'
                          focusable='false'
                        >
                          <path d="M9 1 2.25 4.5 9 8l6.75-3.5L9 1ZM9 8v9l6.75-3.5V5.5L9 8Z"/>
                        </svg>
                      </span>
                    {%- endif -%}
                    {%- liquid
                      assign image_height = 80
                      assign image_width = 80
                      if media.aspect_ratio < 1
                        assign image_width = image_height | times: media.aspect_ratio | ceil
                      else
                        assign image_height = image_width | divided_by: media.aspect_ratio | ceil
                      endif
                    -%}
                    {{
                      media.preview_image
                      | image_url: width: 160
                      | image_tag:
                        loading: 'lazy',
                        width: image_width,
                        height: image_height,
                        class: 'product-thumbnail__image',
                        alt: media.alt
                      | escape
                    }}
                  </button>
                </div>
              {%- endunless -%}
            {%- endfor -%}
          </div>
        </div>

        {%- comment -%} Thumbnail Navigation {%- endcomment -%}
        <div class='product-thumbnails-navigation'>
          <button
            type='button'
            class='product-thumbnails-nav product-thumbnails-nav--prev'
            aria-label='Previous thumbnails'
          >
            <svg class='icon icon-caret' viewBox='0 0 10 6' role='img' aria-hidden='true' focusable='false'>
              <path fill-rule="evenodd" clip-rule="evenodd" d="m9 5-4-4-4 4 1-1 3-3 3 3 1 1z"/>
            </svg>
          </button>
          <button
            type='button'
            class='product-thumbnails-nav product-thumbnails-nav--next'
            aria-label='Next thumbnails'
          >
            <svg class='icon icon-caret' viewBox='0 0 10 6' role='img' aria-hidden='true' focusable='false'>
              <path fill-rule="evenodd" clip-rule="evenodd" d="m1 1 4 4 4-4-1 1-3 3-3-3-1-1z"/>
            </svg>
          </button>
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} Main Gallery {%- endcomment -%}
    <div class='product-swiper-gallery__main'>
      <div
        class='swiper product-main-swiper{% if media_count == 1 %} product-main-swiper--single{% endif %}'
        id='ProductMainGallery-{{ section.id }}'
      >
        <div class='swiper-wrapper'>
          {%- for media in product.media -%}
            {%- unless section.settings.hide_variants
              and variant_images contains media
              and media.id != featured_media.id
            -%}
              <div
                class='swiper-slide product-media-slide'
                data-media-id='{{ media.id }}'
                data-media-type='{{ media.media_type }}'
              >
                {% render 'product-thumbnail',
                  media: media,
                  media_count: media_count,
                  position: forloop.index,
                  desktop_layout: 'swiper_thumbnails',
                  mobile_layout: section.settings.mobile_thumbnails,
                  loop: section.settings.enable_video_looping,
                  modal_id: section.id,
                  xr_button: true,
                  media_width: media_width,
                  media_fit: section.settings.media_fit,
                  constrain_to_viewport: section.settings.constrain_to_viewport,
                  lazy_load: false
                %}
              </div>
            {%- endunless -%}
          {%- endfor -%}
        </div>

        {%- comment -%} Main Gallery Navigation {%- endcomment -%}
        {%- if media_count > 1 -%}
          <div class='product-main-navigation'>
            <button type='button' class='product-main-nav product-main-nav--prev' aria-label='Previous image'>
              <svg class='icon icon-caret' viewBox='0 0 10 6' role='img' aria-hidden='true' focusable='false'>
                <path fill-rule="evenodd" clip-rule="evenodd" d="m9 5-4-4-4 4 1-1 3-3 3 3 1 1z"/>
              </svg>
            </button>
            <button type='button' class='product-main-nav product-main-nav--next' aria-label='Next image'>
              <svg class='icon icon-caret' viewBox='0 0 10 6' role='img' aria-hidden='true' focusable='false'>
                <path fill-rule="evenodd" clip-rule="evenodd" d="m1 1 4 4 4-4-1 1-3 3-3-3-1-1z"/>
              </svg>
            </button>
          </div>
        {%- endif -%}
      </div>

      {%- comment -%} Gallery Indicators {%- endcomment -%}
      {%- if media_count > 1 -%}
        <div class='product-gallery-indicators'>
          <span class='product-gallery-counter'>
            <span class='product-gallery-current'>1</span>
            <span> / </span>
            <span class='product-gallery-total'>{{ media_count }}</span>
          </span>
        </div>
      {%- endif -%}
    </div>
  </div>
</div>
